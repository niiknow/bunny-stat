sources:
  bunny_src:
    type: syslog
    address: '0.0.0.0:6514'
    mode: udp

sinks:
  bunny_file_sink:
    type: file
    inputs:
      - bunny_transform
    compression: none
    path: /logs/bunny_log-%Y-%m-%d.log
    encoding:
      codec: raw_message

  bunny_search_sink:
    type: http
    inputs:
      - bunny_shaker
    uri: 'http://openobserve:5080/api/default/bunny_log/_json'
    method: post
    auth:
      strategy: basic
      user: "${SEARCH_EMAIL:?search email is required}"
      password: "${SEARCH_PWD:?search pwd is required}"
    compression: gzip
    batch:
      timeout_secs: 10
    encoding:
      codec: raw_message
    healthcheck:
      enabled: false

  bunny_metric_exporter:
    type: prometheus_exporter
    inputs:
      - bunny_metric
    default_namespace: bunny
    flush_period_secs: 20
    # address: 0.0.0.0:9598 # this is already default

  # alternate to bunny_metric_exporter above
  bunny_metric_sink:
    type: prometheus_remote_write
    inputs:
      - bunny_metric
    endpoint: "http://openobserve:5080/api/default/prometheus/api/v1/write"
    default_namespace: bunny
    auth:
      strategy: basic
      user: "${SEARCH_EMAIL:?search email is required}"
      password: "${SEARCH_PWD:?search pwd is required}"
    batch:
      timeout_secs: 10

transforms:
  # optionally verify bunnycdn token/password
  # password going to come in as the event object key: OptionalBunnyToken@workerid
  bunny_prefilter:
    type: filter
    inputs:
      - bunny_src
    condition: 'starts_with(string!(keys(.)[0]), get_env_var!("BUNNY_TOKEN"))'

  # parse log PathAndQuery for /shake aka tree shaking
  # to get event Action(ea), Category (ec), and Value (ev)
  bunny_transform:
    type: remap
    inputs:
      - bunny_prefilter
    file: /etc/vector/stat-transform.vrl

  bunny_shaker:
    type: filter
    inputs:
      - bunny_transform
    condition: .request_type == "shaker"

  bunny_metric:
    type: log_to_metric
    inputs:
      - bunny_shaker
    metrics:
      - type: counter
        field: message.ev
        name: "event_{{ message.ec }}"
        namespace: bunny
        _timestamp: message._timestamp
        tags:
          action: "{{ message.ea }}"
          label: "{{ message.el }}"
          value: "{{ message.ev }}"
